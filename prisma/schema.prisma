generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  OWNER
  ADMIN
  MAINTAINER
  SUBSCRIBED_USER
  GUEST
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PENDING
}

model User {
  id                    String    @id @default(cuid())
  username              String    @unique
  email                 String    @unique
  encryptedEmail        String    // AES-256 encrypted
  password              String    // bcrypt hashed
  role                  Role      @default(GUEST)
  isEmailVerified       Boolean   @default(false)
  emailVerificationToken String?  @unique
  
  // 2FA
  twoFactorEnabled      Boolean   @default(false)
  twoFactorSecret       String?
  backupCodes           String?   // JSON array of hashed codes
  
  // Guest access
  guestAccessExpiresAt  DateTime?
  
  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  lastLoginAt           DateTime?
  
  // Relations
  subscriptions         Subscription[]
  apiKeys               ApiKey[]
  trustedDevices        TrustedDevice[]
  refreshTokens         RefreshToken[]
  
  @@index([email])
  @@index([role])
  @@map("users")
}

model Service {
  id                String         @id @default(cuid())
  name              String         @unique
  description       String         @db.Text
  price             Float
  allowedAlgorithms String         @db.Text // JSON array
  rateLimit         Int
  ratePeriod        Int            // in seconds
  stripePriceId     String?
  isActive          Boolean        @default(true)
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  subscriptions     Subscription[]
  
  @@index([isActive])
  @@map("services")
}

model Subscription {
  id                    String             @id @default(cuid())
  userId                String
  serviceId             String
  status                SubscriptionStatus @default(PENDING)
  startDate             DateTime           @default(now())
  expiresAt             DateTime?
  cancelledAt           DateTime?
  renewCount            Int                @default(0)
  
  // Stripe
  stripeSubscriptionId  String?            @unique
  stripeCustomerId      String?
  paymentMethod         String?
  
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  
  user                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  service               Service            @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([serviceId])
  @@index([status])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}

model ApiKey {
  id                String    @id @default(cuid())
  userId            String
  name              String
  keyHash           String    @unique // Hashed API key
  keyPrefix         String    // First 8 chars for display
  
  lastUsedAt        DateTime?
  usageCount        Int       @default(0)
  expiresAt         DateTime?
  isRevoked         Boolean   @default(false)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([keyHash])
  @@index([isRevoked])
  @@map("api_keys")
}

model TrustedDevice {
  id                String    @id @default(cuid())
  userId            String
  deviceToken       String    @unique
  deviceName        String?
  deviceFingerprint String
  ipAddress         String?
  userAgent         String?
  
  lastUsedAt        DateTime  @default(now())
  expiresAt         DateTime
  
  createdAt         DateTime  @default(now())
  
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([deviceToken])
  @@index([expiresAt])
  @@map("trusted_devices")
}

model RefreshToken {
  id                String    @id @default(cuid())
  userId            String
  tokenHash         String    @unique
  
  expiresAt         DateTime
  createdAt         DateTime  @default(now())
  
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("refresh_tokens")
}